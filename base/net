#!/bin/bash
if [ $EUID != 0 ]; then
    sudo "$0" "$@"
    exit $?
fi

perfil="$1" # Nombre del perfil de netctl

#region Colores
CLR_ROJO="\e[91m"
CLR_VERD="\e[92m"
CLR_AMAR="\e[93m"
CLR_FIN="\e[m"
#endregion

#region Funciones
_echo() {
    echo -e "$CLR_VERD$1 $CLR_AMAR$2$CLR_FIN"
}

_echo_r() {
    echo -en "$1 $CLR_AMAR$2$CLR_FIN\r"
}

_error() {
    echo -e "$CLR_ROJO$1$CLR_FIN"
    exit 1
}
#endregion

# Me fijo si existe el perfil, y salgo si no existe
if [ ! -f "/etc/netctl/$perfil" ]; then
    _error "El perfil \"$perfil\" no existe"
fi

# Me fijo si ya estoy/estaba conectado a una red (debe aparecer un * al lado
# del nombre del perfil al que estoy conectado en "netctl list".
if netctl list | grep -q "*"; then
    _echo_r "Cambiando a perfil" "$perfil"
    netctl switch-to "$perfil"
    _echo   "Cambiado a perfil" "$perfil "
else
    interfaz=`cat /etc/netctl/$perfil |
                  grep "^Interface" |
                  grep -Eo "[^=]+$"`
    _echo_r "Desactivando la interfaz" "$interfaz"
    ip l set "$interfaz" down
    _echo   "Interfaz desactivada" "$interfaz    "

    _echo_r "Iniciando perfil" "$perfil"
    netctl start "$perfil"
    _echo   "Iniciado perfil" "$perfil "
fi

if [ $? -eq 0 ]; then
    _echo_r "Detectando dirección IP..."
    while :; do
        ip=`ip -br -c a | \
                grep -Eo "([0-9]{1,3}[\.]){3}[0-9]{1,3}" | \
                grep -e ^192. -e ^10. -e ^168.`
        if [ "$ip" ]; then
            break
        fi
        sleep 0.1
    done
    _echo   "Dirección IP:" "$ip"
else
    _error Error
fi
