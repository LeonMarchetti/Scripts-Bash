#!/bin/bash
if [ $EUID != 0 ]; then
    sudo "$0" "$@"
    exit $?
fi

#region Colores
CLR_AMAR="\e[93m"
CLR_VERD="\e[92m"
CLR_ROJO="\e[91m"
CLR_FIN="\e[m"
#endregion

#region Globales
# Listas de servicios y puertos activados por este script. Al terminar el
# programa se detienen y cierran los servicios y puertos en estas listas.
servicios=()
puertos=()
#endregion

#region Funciones
main() {
    trap terminar EXIT

    procesar_argumentos "$@"

    echo
    echo -n "Esperando interrupción..."

    while :; do
        read -n 1 || terminar
        if [ $? = 0 ] ; then
            break
        fi
    done
}

_error() {
    if [ "$2" ]; then
        echo -e "${CLR_ROJO}start: $2${CLR_FIN}" >&2
    fi
    exit $1
}

procesar_argumentos() {
    # Bandera para indicar si el argumento es un "SERVICIO" o un "PUERTO" durante
    # el procesamiento de los argumentos.
    local flag=
    while [ "$1" ]; do
        case "$1" in
            -s) flag="SERVICIO" ;;
            -p) flag="PUERTO" ;;
            -*) _error 1 "Opción desconocida ${CLR_AMAR}$1" ;;
            *)
                case $flag in
                    SERVICIO) iniciar_servicio $1 ;;
                    PUERTO) permitir_puerto $1 ;;
                    *) echo -e "Ignorando argumento ${CLR_AMAR}$1${CLR_FIN}"
                esac
                ;;
        esac
        shift
    done
}

iniciar_servicio() {
    if ! servicio_existe "$1"; then
        _error 2 "El servicio ${CLR_AMAR}$1${CLR_ROJO} no existe, terminando..."
    fi

    if servicio_esta_activo "$1"; then
        echo -e "El servicio ${CLR_AMAR}$1${CLR_FIN} ya estaba iniciado, ignorando..."
        return
    fi

    echo -e "${CLR_VERD}Iniciando${CLR_FIN} servicio ${CLR_AMAR}$1${CLR_FIN}..."
    systemctl start "$1"
    servicios+=($1)
}

servicio_existe() {
    systemctl status "$1" 1&> /dev/null
    if [ "$?" -eq 4 ]; then
        return 1
    fi
}

servicio_esta_activo() {
    systemctl is-active -q "$1"
}

permitir_puerto() {
    case `ufw status | grep "$1 [^\(]" | grep -Eo "(ALLOW|DENY)"` in
        "ALLOW") echo -e "El puerto ${CLR_AMAR}$1${CLR_FIN} ya estaba permitido, ignorando..." ;;
        "DENY")
            echo -e "${CLR_VERD}Permitiendo${CLR_FIN} puerto ${CLR_AMAR}$1${CLR_FIN}..."
            ufw allow "$1" &> /dev/null
            puertos+=($1)
            ;;
        *) echo -e "${CLR_ROJO}Estado de puerto ${CLR_AMAR}$1${CLR_ROJO} desconocido${CLR_FIN}" ;;
    esac
}

terminar() {
    echo -en "\r\e[K"
    for serv in ${servicios[*]}; do
        echo -e "${CLR_ROJO}Deteniendo${CLR_FIN} servicio ${CLR_AMAR}$serv${CLR_FIN}..."
        systemctl stop "$serv"
    done

    for port in ${puertos[*]}; do
        echo -e "${CLR_ROJO}Denegando${CLR_FIN} puerto ${CLR_AMAR}$port${CLR_FIN}..."
        ufw deny "$port" &> /dev/null
    done
}
#endregion

main "$@"
